<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/109-application-skills/101-queues/100-practical-patterns-antipatterns.md"></div> <h1 id="practical-patterns-and-antipatterns-for-queues-in-postgresql">Practical Patterns and Antipatterns for Queues in PostgreSQL</h1>
<p>Using PostgreSQL for implementing queues is a common practice. Here, we will discuss some practical patterns and antipatterns that you should be aware of when working with queues in PostgreSQL.</p>
<h2 id="patterns">Patterns</h2>
<h3 id="implementing-a-simple-queue-using-skip-locked">Implementing a simple queue using SKIP LOCKED</h3>
<p>A simple way to implement a queue is by using the <code>SKIP LOCKED</code> functionality that PostgreSQL offers. We use a table <code>jobs</code> to store our queue items:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> TABLE</span><span style="color:#50FA7B"> jobs</span><span style="color:#F8F8F2"> (</span></span>
<span class="line"><span style="color:#F8F8F2">    id </span><span style="color:#FF79C6">SERIAL</span><span style="color:#FF79C6"> PRIMARY KEY</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    payload JSONB,</span></span>
<span class="line"><span style="color:#FF79C6">    status</span><span style="color:#FF79C6"> VARCHAR</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">20</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">NOT NULL</span><span style="color:#FF79C6"> DEFAULT</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">PENDING</span><span style="color:#E9F284">'</span></span>
<span class="line"><span style="color:#F8F8F2">);</span></span>
<span class="line"></span></code></pre>
<p>Queue items can be inserted like this:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">INSERT INTO</span><span style="color:#F8F8F2"> jobs (payload) </span><span style="color:#FF79C6">VALUES</span><span style="color:#F8F8F2"> (</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">{"task": "do something"}</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span></code></pre>
<p>And dequeued items can then be fetched like this:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">BEGIN</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#FF79C6"> *</span><span style="color:#FF79C6"> FROM</span><span style="color:#F8F8F2"> jobs </span><span style="color:#FF79C6">WHERE</span><span style="color:#FF79C6"> status</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">PENDING</span><span style="color:#E9F284">'</span></span>
<span class="line"><span style="color:#FF79C6">ORDER BY</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">ASC</span></span>
<span class="line"><span style="color:#FF79C6">FOR</span><span style="color:#FF79C6"> UPDATE</span><span style="color:#FF79C6"> SKIP</span><span style="color:#F8F8F2"> LOCKED</span></span>
<span class="line"><span style="color:#FF79C6">LIMIT</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#6272A4">-- now do something with the dequeued job</span></span>
<span class="line"><span style="color:#FF79C6">UPDATE</span><span style="color:#F8F8F2"> jobs </span><span style="color:#FF79C6">SET</span><span style="color:#FF79C6"> status</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">DONE</span><span style="color:#E9F284">'</span><span style="color:#FF79C6"> WHERE</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> &#x3C;</span><span style="color:#F8F8F2">dequeued_id</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">COMMIT</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span></code></pre>
<h3 id="implementing-a-retry-mechanism-using-a-separate-column">Implementing a retry mechanism using a separate column</h3>
<p>In real-life situations, you might want to retry failed jobs in your queue. To do so, you can add a <code>retries</code> column to your jobs table:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">ALTER</span><span style="color:#FF79C6"> TABLE</span><span style="color:#F8F8F2"> jobs </span><span style="color:#FF79C6">ADD</span><span style="color:#F8F8F2"> COLUMN retries </span><span style="color:#FF79C6">INT</span><span style="color:#FF79C6"> DEFAULT</span><span style="color:#BD93F9"> 3</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span></code></pre>
<p>And modify the dequeue query to handle failed jobs:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">BEGIN</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#FF79C6"> *</span><span style="color:#FF79C6"> FROM</span><span style="color:#F8F8F2"> jobs </span><span style="color:#FF79C6">WHERE</span><span style="color:#FF79C6"> status</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">PENDING</span><span style="color:#E9F284">'</span><span style="color:#FF79C6"> OR</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">status</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">FAILED</span><span style="color:#E9F284">'</span><span style="color:#FF79C6"> AND</span><span style="color:#F8F8F2"> retries </span><span style="color:#FF79C6">></span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">ORDER BY</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">ASC</span></span>
<span class="line"><span style="color:#FF79C6">FOR</span><span style="color:#FF79C6"> UPDATE</span><span style="color:#FF79C6"> SKIP</span><span style="color:#F8F8F2"> LOCKED</span></span>
<span class="line"><span style="color:#FF79C6">LIMIT</span><span style="color:#BD93F9"> 1</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#6272A4">-- now do something with the dequeued job</span></span>
<span class="line"><span style="color:#6272A4">-- if successful:</span></span>
<span class="line"><span style="color:#FF79C6">UPDATE</span><span style="color:#F8F8F2"> jobs </span><span style="color:#FF79C6">SET</span><span style="color:#FF79C6"> status</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">DONE</span><span style="color:#E9F284">'</span><span style="color:#FF79C6"> WHERE</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> &#x3C;</span><span style="color:#F8F8F2">dequeued_id</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#6272A4">-- if failed:</span></span>
<span class="line"><span style="color:#FF79C6">UPDATE</span><span style="color:#F8F8F2"> jobs </span><span style="color:#FF79C6">SET</span><span style="color:#FF79C6"> status</span><span style="color:#FF79C6"> =</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">FAILED</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, retries </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> retries </span><span style="color:#FF79C6">-</span><span style="color:#BD93F9"> 1</span><span style="color:#FF79C6"> WHERE</span><span style="color:#F8F8F2"> id </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6"> &#x3C;</span><span style="color:#F8F8F2">dequeued_id</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">COMMIT</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span></code></pre>
<h2 id="antipatterns">Antipatterns</h2>
<h3 id="polling-for-queue-items">Polling for queue items</h3>
<p>One common antipattern is polling the database for new queue items. This can be computationally expensive and can severely impact the performance of your overall implementation. Instead, consider using <code>SKIP LOCKED</code> as described earlier and make use of PostgreSQL’s row-level locking mechanism.</p>
<h3 id="using-expensive-data-types-for-payload">Using expensive data types for payload</h3>
<p>When inserting payload data into your jobs table, it’s important to use suitable data types. For instance, storing payload data in a <code>JSONB</code> column can result in parsing and storing overhead. Depending on your use case, consider using simpler data types like <code>VARCHAR</code>, <code>INTEGER</code>, or even byte arrays.</p>
<h3 id="simultaneously-dequeuing-multiple-items">Simultaneously dequeuing multiple items</h3>
<p>While it might be tempting to dequeue multiple items at once to optimize performance, this can lead to inefficiencies and may cause your transactions to wait for locks. Instead, only dequeue a single item at a time using <code>LIMIT 1</code> in your query.</p>
<p>By following the practical patterns and avoiding the antipatterns, you can make your PostgreSQL-based queue implementation more efficient and functional.</p>