<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/111-troubleshooting-techniques/100-system-views/100-pg-stat-activity.md"></div> <h1 id="pg-stat-activity">Pg Stat Activity</h1>
<p><code>pg_stat_activity</code> is a crucial system view in PostgreSQL that provides real-time information on current database connections and queries being executed. This view is immensely helpful when troubleshooting performance issues, identifying long-running or idle transactions, and managing the overall health of the database.</p>
<h2 id="key-information-in-pg_stat_activity">Key Information in <code>pg_stat_activity</code></h2>
<p>The <code>pg_stat_activity</code> view contains several important fields, which include:</p>
<ul>
<li><code>datid</code>: The OID of the database the backend is connected to.</li>
<li><code>datname</code>: The name of the database the backend is connected to.</li>
<li><code>pid</code>: The process ID of the backend.</li>
<li><code>usesysid</code>: The OID of the user who initiated the backend.</li>
<li><code>usename</code>: The name of the user who initiated the backend.</li>
<li><code>application_name</code>: The name of the application that is connected to the backend.</li>
<li><code>client_addr</code>: The IP address of the client connected to the backend.</li>
<li><code>client_port</code>: The port number of the client connected to the backend.</li>
<li><code>backend_start</code>: The timestamp when the backend was started.</li>
<li><code>xact_start</code>: The start time of the current transaction.</li>
<li><code>query_start</code>: The start time of the current query.</li>
<li><code>state_change</code>: The timestamp of the last state change.</li>
<li><code>state</code>: The current state of the backend (active/idle/idle in transaction).</li>
<li><code>query</code>: The most recent/currently running query of the backend.</li>
</ul>
<h2 id="common-uses">Common Uses</h2>
<p><code>pg_stat_activity</code> is commonly used for several monitoring and diagnostic purposes, such as:</p>
<ul>
<li>
<p><strong>Monitoring active queries:</strong> To get a list of currently running queries, you can use the following query:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>SELECT pid, query, state, query_start</span></span>
<span class="line"><span>FROM pg_stat_activity</span></span>
<span class="line"><span>WHERE state = 'active';</span></span>
<span class="line"><span></span></span></code></pre>
</li>
<li>
<p><strong>Identifying idle transactions:</strong> To detect idle transactions, which can cause performance issues, use this query:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>SELECT pid, query, state, xact_start</span></span>
<span class="line"><span>FROM pg_stat_activity</span></span>
<span class="line"><span>WHERE state = 'idle in transaction';</span></span>
<span class="line"><span></span></span></code></pre>
</li>
<li>
<p><strong>Terminating long-running queries:</strong> To terminate specific long-running queries or backends, you can use the <code>pg_terminate_backend()</code> function. For example, to terminate a backend with the process ID <code>12345</code>:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>SELECT pg_terminate_backend(12345);</span></span>
<span class="line"><span></span></span></code></pre>
</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Understanding and utilizing the <code>pg_stat_activity</code> system view is vital when maintaining the performance and health of a PostgreSQL database. This view provides you with valuable insights into database connections and queries, allowing you to monitor, diagnose, and act accordingly to maintain a robust and optimally performing system.</p>