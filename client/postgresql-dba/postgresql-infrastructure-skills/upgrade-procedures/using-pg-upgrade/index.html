<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/107-postgresql-infrastructure-skills/103-upgrade-procedures/100-using-pg-upgrade.md"></div> <h1 id="using-pg_upgrade">Using pg_upgrade</h1>
<p><code>pg_upgrade</code> is a utility that allows you to perform an in-place upgrade of your PostgreSQL database cluster to a new major version, minimizing downtime. It is a faster and more convenient method when compared to the traditional dump and reload upgrade procedure. In this section, we’ll briefly discuss how to use <code>pg_upgrade</code> to upgrade your PostgreSQL cluster.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Before using <code>pg_upgrade</code>, ensure that:</p>
<ul>
<li>The new PostgreSQL version is installed on your system.</li>
<li>The old and new versions of <code>pg_ctl</code> and <code>postgres</code> executables are in your <code>PATH</code>.</li>
<li>The database system catalogs are backed up.</li>
</ul>
<h2 id="steps-to-perform-pg_upgrade">Steps to perform pg_upgrade</h2>
<p>Follow these steps to upgrade your PostgreSQL cluster using <code>pg_upgrade</code>:</p>
<ul>
<li>
<p><strong>Stop the old PostgreSQL cluster:</strong> Shutdown the old cluster using <code>pg_ctl</code> command, like:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>pg_ctl -D /path/to/old/data/directory stop</span></span>
<span class="line"><span></span></span></code></pre>
</li>
<li>
<p><strong>Run the pg_upgrade command:</strong> Execute the <code>pg_upgrade</code> command with appropriate options. A basic example:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>pg_upgrade -b /path/to/old/bin -B /path/to/new/bin \</span></span>
<span class="line"><span>           -d /path/to/old/data -D /path/to/new/data \</span></span>
<span class="line"><span>           --check</span></span>
<span class="line"><span></span></span></code></pre>
<p>Here,
<code>-b</code> and <code>-B</code> specify the paths to the old and new <code>bin</code> directories, respectively.
<code>-d</code> and <code>-D</code> specify the paths to the old and new data directories, respectively.
<code>--check</code> option performs a test run, checking for any potential issues without performing the actual upgrade.</p>
</li>
<li>
<p><strong>Analyze the test results:</strong> If the <code>--check</code> option reports any issues, address them before proceeding with the actual upgrade.</p>
</li>
<li>
<p><strong>Run the actual pg_upgrade:</strong> Execute the <code>pg_upgrade</code> command without the <code>--check</code> option to perform the actual upgrade:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>pg_upgrade -b /path/to/old/bin -B /path/to/new/bin \</span></span>
<span class="line"><span>           -d /path/to/old/data -D /path/to/new/data</span></span>
<span class="line"><span></span></span></code></pre>
</li>
<li>
<p><strong>Analyze the new cluster:</strong> Run the <code>analyze_new_cluster.sh</code> script generated by <code>pg_upgrade</code>. This script will perform an <code>ANALYZE</code> operation on the new cluster to update optimizer statistics.</p>
</li>
<li>
<p><strong>Start the new PostgreSQL cluster:</strong> Use the <code>pg_ctl</code> command to start the new cluster:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>pg_ctl -D /path/to/new/data/directory start</span></span>
<span class="line"><span></span></span></code></pre>
</li>
<li>
<p><strong>Perform a cleanup:</strong> Once you are satisfied with the new cluster’s performance, clean up the old cluster’s data and configuration files by running the generated <code>delete_old_cluster.sh</code> script.</p>
</li>
</ul>
<p>That’s it! With these steps, you should have successfully upgraded your PostgreSQL cluster using <code>pg_upgrade</code>. For more information about <code>pg_upgrade</code>, its options and troubleshooting, refer to the <a href="https://www.postgresql.org/docs/current/pgupgrade.html" rel="noopener noreferrer nofollow" target="_blank">official PostgreSQL documentation</a>.</p>