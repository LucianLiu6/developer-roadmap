<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/104-learn-sql-concepts/103-advanced-topics/102-subqueries.md"></div> <h1 id="subqueries">Subqueries</h1>
<p>A subquery is a query nested inside another query, often referred to as the outer query. Subqueries are invaluable tools for retrieving information from multiple tables, performing complex calculations, or applying filter criteria based on the results of other queries. They can be found in various parts of SQL statements, such as <code>SELECT</code>, <code>FROM</code>, <code>WHERE</code>, and <code>HAVING</code> clauses.</p>
<h2 id="types-of-subqueries">Types of Subqueries</h2>
<h3 id="scalar-subqueries">Scalar Subqueries</h3>
<p>A scalar subquery is a subquery that returns a single value (i.e., one row and one column). Scalar subqueries can be used in places where a single value is expected, like in a comparison or an arithmetic expression.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#BD93F9"> employees</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">name</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">employees</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">salary</span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> employees</span></span>
<span class="line"><span style="color:#FF79C6">WHERE</span><span style="color:#BD93F9"> employees</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">salary</span><span style="color:#FF79C6"> ></span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">SELECT</span><span style="color:#8BE9FD"> AVG</span><span style="color:#F8F8F2">(salary) </span><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> employees);</span></span>
<span class="line"></span></code></pre>
<h3 id="row-subqueries">Row Subqueries</h3>
<p>Row subqueries return a single row with multiple columns. These subqueries can be used in comparisons where a row of values is expected.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#FF79C6"> *</span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> orders</span></span>
<span class="line"><span style="color:#FF79C6">WHERE</span><span style="color:#F8F8F2"> (order_id, total) </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">SELECT</span><span style="color:#F8F8F2"> order_id, total </span><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> orders </span><span style="color:#FF79C6">WHERE</span><span style="color:#F8F8F2"> order_id </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> 1001</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span></code></pre>
<h3 id="column-subqueries">Column Subqueries</h3>
<p>Column subqueries return multiple rows and a single column. These can be used in predicates like <code>IN</code>, <code>ALL</code>, and <code>ANY</code>.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#F8F8F2"> product_name, price</span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> products</span></span>
<span class="line"><span style="color:#FF79C6">WHERE</span><span style="color:#F8F8F2"> price </span><span style="color:#FF79C6">IN</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">SELECT</span><span style="color:#8BE9FD"> MAX</span><span style="color:#F8F8F2">(price) </span><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> products </span><span style="color:#FF79C6">GROUP BY</span><span style="color:#F8F8F2"> category_id);</span></span>
<span class="line"></span></code></pre>
<h3 id="table-subqueries">Table Subqueries</h3>
<p>Table subqueries, also known as derived tables or inline views, return multiple rows and columns. They are used in the <code>FROM</code> clause and can be treated like any other table.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#BD93F9"> top_customers</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">name</span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> (</span><span style="color:#FF79C6">SELECT</span><span style="color:#F8F8F2"> customer_id, </span><span style="color:#8BE9FD">SUM</span><span style="color:#F8F8F2">(total) </span><span style="color:#FF79C6">as</span><span style="color:#F8F8F2"> total_spent</span></span>
<span class="line"><span style="color:#FF79C6">      FROM</span><span style="color:#F8F8F2"> orders</span></span>
<span class="line"><span style="color:#FF79C6">      GROUP BY</span><span style="color:#F8F8F2"> customer_id</span></span>
<span class="line"><span style="color:#FF79C6">      HAVING</span><span style="color:#8BE9FD"> SUM</span><span style="color:#F8F8F2">(total) </span><span style="color:#FF79C6">></span><span style="color:#BD93F9"> 1000</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">AS</span><span style="color:#F8F8F2"> top_customers;</span></span>
<span class="line"></span></code></pre>
<h2 id="subquery-execution-and-performance-considerations">Subquery Execution and Performance Considerations</h2>
<p>Subqueries can have a significant impact on the performance of your queries. In general, try to write your subqueries in such a way that they minimize the number of returned rows. This can often lead to faster execution times.</p>
<p>Also, PostgreSQL might optimize subqueries, such as transforming <code>IN</code> predicates with subqueries into <code>JOIN</code> operations or applying various other optimizations to make execution more efficient.</p>
<p>In conclusion, subqueries are a powerful tool that can help you retrieve and manipulate data that spans multiple tables or requires complex calculations. By understanding the different types of subqueries and their performance implications, you can write more efficient and effective SQL code.</p>