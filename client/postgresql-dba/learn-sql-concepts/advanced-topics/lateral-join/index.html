<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/104-learn-sql-concepts/103-advanced-topics/103-lateral-join.md"></div> <h1 id="lateral-join-in-postgresql">Lateral Join in PostgreSQL</h1>
<p>In this section, we’ll discuss a powerful feature in PostgreSQL called “Lateral Join”. Lateral join allows you to reference columns from preceding tables in a query, making it possible to perform complex operations that involve correlated subqueries and the application of functions on tables in a cleaner and more effective way.</p>
<h2 id="understanding-lateral-join">Understanding Lateral Join</h2>
<p>The <code>LATERAL</code> keyword in PostgreSQL is used in conjunction with a subquery in the <code>FROM</code> clause of a query. It helps you to write more concise and powerful queries, as it allows the subquery to reference columns from preceding tables in the query.</p>
<p>The main advantage of using the <code>LATERAL</code> keyword is that it enables you to refer to columns from a preceding table in a subquery that is part of the <code>FROM</code> clause when performing a join operation.</p>
<p>Here’s a simple illustration of the lateral join syntax:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#FF79C6"> &#x3C;</span><span style="color:#F8F8F2">column_list</span><span style="color:#FF79C6">></span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#FF79C6"> &#x3C;</span><span style="color:#F8F8F2">table1</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">LATERAL (</span><span style="color:#FF79C6">&#x3C;</span><span style="color:#F8F8F2">subquery</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">AS</span><span style="color:#FF79C6"> &#x3C;</span><span style="color:#F8F8F2">alias</span><span style="color:#FF79C6">></span></span>
<span class="line"></span></code></pre>
<h2 id="when-to-use-lateral-joins">When to Use Lateral Joins?</h2>
<p>Using lateral joins becomes helpful when you have the following requirements:</p>
<ul>
<li>Need complex calculations done within subqueries that depend on values from earlier tables in the join list.</li>
<li>Need to perform powerful filtering or transformations using a specific function.</li>
<li>Dealing with hierarchical data and require results from a parent-child relationship.</li>
</ul>
<h2 id="example-of-lateral-join">Example of Lateral Join</h2>
<p>Consider the following example, where you have two tables: <code>employees</code> and <code>salaries</code>. We’ll calculate the total salary by department and the average salary for each employee.</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> TABLE</span><span style="color:#50FA7B"> employees</span><span style="color:#F8F8F2"> (</span></span>
<span class="line"><span style="color:#F8F8F2">  id </span><span style="color:#FF79C6">serial</span><span style="color:#FF79C6"> PRIMARY KEY</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#FF79C6">  name</span><span style="color:#FF79C6"> varchar</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">100</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">  department </span><span style="color:#FF79C6">varchar</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">50</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> TABLE</span><span style="color:#50FA7B"> salaries</span><span style="color:#F8F8F2"> (</span></span>
<span class="line"><span style="color:#F8F8F2">  id </span><span style="color:#FF79C6">serial</span><span style="color:#FF79C6"> PRIMARY KEY</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">  employee_id </span><span style="color:#FF79C6">integer</span><span style="color:#FF79C6"> REFERENCES</span><span style="color:#F8F8F2"> employees (id),</span></span>
<span class="line"><span style="color:#F8F8F2">  salary </span><span style="color:#FF79C6">numeric</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">10</span><span style="color:#F8F8F2">,</span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">--Example data</span></span>
<span class="line"><span style="color:#FF79C6">INSERT INTO</span><span style="color:#F8F8F2"> employees (</span><span style="color:#FF79C6">name</span><span style="color:#F8F8F2">, department) </span><span style="color:#FF79C6">VALUES</span><span style="color:#F8F8F2"> </span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Alice</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">HR</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Bob</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">IT</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Charlie</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">IT</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">David</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">HR</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">INSERT INTO</span><span style="color:#F8F8F2"> salaries (employee_id, salary) </span><span style="color:#FF79C6">VALUES</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1000</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1100</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">2000</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">3</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">3000</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">3</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">3100</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">4</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">4000</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">--Using LATERAL JOIN</span></span>
<span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#BD93F9"> e</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">name</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">e</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">department</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">s</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">total_salary</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">s</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">avg_salary</span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> employees e</span></span>
<span class="line"><span style="color:#FF79C6">JOIN</span><span style="color:#F8F8F2"> LATERAL (</span></span>
<span class="line"><span style="color:#FF79C6">  SELECT</span><span style="color:#8BE9FD"> SUM</span><span style="color:#F8F8F2">(salary) </span><span style="color:#FF79C6">as</span><span style="color:#F8F8F2"> total_salary, </span><span style="color:#8BE9FD">AVG</span><span style="color:#F8F8F2">(salary) </span><span style="color:#FF79C6">as</span><span style="color:#F8F8F2"> avg_salary</span></span>
<span class="line"><span style="color:#FF79C6">  FROM</span><span style="color:#F8F8F2"> salaries</span></span>
<span class="line"><span style="color:#FF79C6">  WHERE</span><span style="color:#F8F8F2"> employee_id </span><span style="color:#FF79C6">=</span><span style="color:#BD93F9"> e</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">id</span></span>
<span class="line"><span style="color:#F8F8F2">) s </span><span style="color:#FF79C6">ON</span><span style="color:#F8F8F2"> TRUE;</span></span>
<span class="line"></span></code></pre>
<p>In this example, we use lateral join to reference the <code>employee_id</code> column in the employees table while aggregating salaries in a subquery. The query returns the total and average salary for each employee by department.</p>
<p>So, in conclusion, lateral joins provide an efficient way to access values from preceding tables within a subquery, allowing for more clean and concise queries in PostgreSQL.</p>