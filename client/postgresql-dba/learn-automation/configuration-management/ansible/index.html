<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/108-learn-automation/102-configuration-management/100-ansible.md"></div> <h1 id="ansible-for-postgresql-configuration-management">Ansible for PostgreSQL Configuration Management</h1>
<p>Ansible is a widely used open-source configuration management and provisioning tool that helps automate many tasks for managing servers, databases, and applications. It uses a simple, human-readable language called YAML to define automation scripts, known as “playbooks.” In this section, we’ll explore how Ansible can help manage PostgreSQL configurations.</p>
<h2 id="key-features-of-ansible">Key Features of Ansible</h2>
<ul>
<li>Agentless: Ansible does not require installing any agents or software on the servers being managed, making it easy to set up and maintain.</li>
<li>Playbooks: Playbooks are the core component of Ansible, and they define automation tasks using YAML. They are simple to understand and write.</li>
<li>Modules: Ansible modules are reusable components that perform specific actions, such as installing packages, creating databases, or managing services. There are numerous built-in modules for managing PostgreSQL.</li>
<li>Idempotent: Ansible ensures that playbook runs have the same effect, regardless of how many times they are executed. This ensures consistent server and application configuration.</li>
<li>Inventory: Ansible uses an inventory to track and manage hosts. It is a flexible system that can group and organize servers based on their characteristics or functions.</li>
</ul>
<h2 id="using-ansible-with-postgresql">Using Ansible with PostgreSQL</h2>
<ul>
<li>
<p><strong>Install Ansible</strong>: First, you’ll need to install Ansible on your control machine (the machine where you’ll execute playbooks from), using your package manager or following the official <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html" rel="noopener noreferrer nofollow" target="_blank">installation guide</a>.</p>
</li>
<li>
<p><strong>Create a playbook</strong>: Create a new playbook file (e.g., <code>postgres_setup.yml</code>) to define the automation tasks for PostgreSQL. In this file, you’ll write YAML instructions to perform tasks like installation, configuration, and database setup.</p>
</li>
<li>
<p><strong>Use the PostgreSQL modules</strong>: Ansible has built-in support for PostgreSQL through several modules, such as <code>postgresql_db</code>, <code>postgresql_user</code>, and <code>postgresql_privs</code>. Use these modules in your playbooks to manage your PostgreSQL server and databases.</p>
</li>
<li>
<p><strong>Apply the playbook</strong>: Once you have created the playbook, you can apply it with the <code>ansible-playbook</code> command, specifying the inventory file and the target hosts.</p>
</li>
</ul>
<p>Example playbook for installing PostgreSQL on Ubuntu:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#F8F8F2">---</span></span>
<span class="line"><span style="color:#FF79C6">-</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Install PostgreSQL</span></span>
<span class="line"><span style="color:#8BE9FD">  hosts</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> all</span></span>
<span class="line"><span style="color:#8BE9FD">  become</span><span style="color:#FF79C6">:</span><span style="color:#BD93F9"> yes</span></span>
<span class="line"><span style="color:#8BE9FD">  tasks</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">    -</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Update apt cache</span></span>
<span class="line"><span style="color:#8BE9FD">      apt</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> update_cache=yes cache_valid_time=3600</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    -</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Install required packages</span></span>
<span class="line"><span style="color:#8BE9FD">      apt</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> name={{ item }} state=present</span></span>
<span class="line"><span style="color:#8BE9FD">      loop</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">        -</span><span style="color:#F1FA8C"> python3-psycopg2</span></span>
<span class="line"><span style="color:#FF79C6">        -</span><span style="color:#F1FA8C"> postgresql</span></span>
<span class="line"><span style="color:#FF79C6">        -</span><span style="color:#F1FA8C"> postgresql-contrib</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    -</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Configure PostgreSQL</span></span>
<span class="line"><span style="color:#8BE9FD">      block</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">        -</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Add custom configuration</span></span>
<span class="line"><span style="color:#8BE9FD">          template</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#8BE9FD">            src</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> templates/pg_hba.conf.j2</span></span>
<span class="line"><span style="color:#8BE9FD">            dest</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> /etc/postgresql/{{ postgres_version }}/main/pg_hba.conf</span></span>
<span class="line"><span style="color:#8BE9FD">          notify</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Restart PostgreSQL</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        -</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Reload configuration</span></span>
<span class="line"><span style="color:#8BE9FD">          systemd</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> name=postgresql state=reloaded</span></span>
<span class="line"><span style="color:#8BE9FD">  handlers</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">    -</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Restart PostgreSQL</span></span>
<span class="line"><span style="color:#8BE9FD">      systemd</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> name=postgresql state=restarted</span></span>
<span class="line"></span></code></pre>
<p>In this example, the playbook installs the required packages, configures PostgreSQL using a custom <code>pg_hba.conf</code> file (from a Jinja2 template), and then reloads and restarts the PostgreSQL service.</p>
<h2 id="pglift-for-ansible">pgLift for Ansible</h2>
<p>pgLift is a PostgreSQL automation tool that helps you manage your PostgreSQL servers and databases. It includes a set of Ansible modules that can be used to automate common tasks, such as creating databases, users, and extensions, or managing replication and backups.</p>
<p>pgLift modules are available on <a href="https://galaxy.ansible.com/pglift" rel="noopener noreferrer nofollow" target="_blank">Ansible Galaxy</a>, and can be installed using the <code>ansible-galaxy</code> command:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#50FA7B">ansible-galaxy</span><span style="color:#F1FA8C"> collection</span><span style="color:#F1FA8C"> install</span><span style="color:#F1FA8C"> pglift.pglift</span></span>
<span class="line"></span></code></pre>
<p>Once installed, you can use the modules in your playbooks:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#F8F8F2">---</span></span>
<span class="line"><span style="color:#FF79C6">-</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Create a database</span></span>
<span class="line"><span style="color:#8BE9FD">  hosts</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> all</span></span>
<span class="line"><span style="color:#8BE9FD">  become</span><span style="color:#FF79C6">:</span><span style="color:#BD93F9"> yes</span></span>
<span class="line"><span style="color:#8BE9FD">  tasks</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#FF79C6">    -</span><span style="color:#8BE9FD"> name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> Create a database</span></span>
<span class="line"><span style="color:#8BE9FD">      pglift.pglift.postgresql_db</span><span style="color:#FF79C6">:</span></span>
<span class="line"><span style="color:#8BE9FD">        name</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> mydb</span></span>
<span class="line"><span style="color:#8BE9FD">        owner</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> myuser</span></span>
<span class="line"><span style="color:#8BE9FD">        encoding</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> UTF8</span></span>
<span class="line"><span style="color:#8BE9FD">        lc_collate</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> en_US.UTF-8</span></span>
<span class="line"><span style="color:#8BE9FD">        lc_ctype</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> en_US.UTF-8</span></span>
<span class="line"><span style="color:#8BE9FD">        template</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> template0</span></span>
<span class="line"><span style="color:#8BE9FD">        state</span><span style="color:#FF79C6">:</span><span style="color:#F1FA8C"> present</span></span>
<span class="line"></span></code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>Ansible is a powerful configuration management tool that can greatly simplify the maintenance and deployment of PostgreSQL servers. By using Ansible playbooks and PostgreSQL modules, you can automate repetitive tasks, ensure consistent configurations, and reduce human error.</p>