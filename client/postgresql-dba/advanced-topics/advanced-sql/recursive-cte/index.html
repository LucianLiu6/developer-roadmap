<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/110-advanced-topics/102-advanced-sql/103-recursive-cte.md"></div> <h1 id="recursive-cte-common-table-expressions">Recursive CTE (Common Table Expressions)</h1>
<p>Recursive CTEs are a powerful feature in SQL that allow you to build complex hierarchical queries, retrieve data stored in hierarchical structures or even perform graph traversal. In simple terms, a recursive CTE is a CTE that refers to itself in its own definition, creating a loop that iterates through the data until a termination condition is met.</p>
<h2 id="syntax">Syntax</h2>
<p>Here’s the basic structure of a recursive CTE:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">WITH</span><span style="color:#FF79C6"> RECURSIVE</span><span style="color:#F8F8F2"> recursive_cte_name (column1, column2, ...) </span><span style="color:#FF79C6">AS</span><span style="color:#F8F8F2"> (</span></span>
<span class="line"><span style="color:#6272A4">  -- Initial, non-recursive query (the "seed")</span></span>
<span class="line"><span style="color:#FF79C6">  SELECT</span><span style="color:#F8F8F2"> ...</span></span>
<span class="line"><span style="color:#F8F8F2">  </span></span>
<span class="line"><span style="color:#FF79C6">  UNION ALL</span><span style="color:#6272A4">  -- or UNION</span></span>
<span class="line"><span style="color:#F8F8F2">  </span></span>
<span class="line"><span style="color:#6272A4">  -- Recursive query (refers to the CTE)</span></span>
<span class="line"><span style="color:#FF79C6">  SELECT</span><span style="color:#F8F8F2"> ...</span></span>
<span class="line"><span style="color:#FF79C6">  FROM</span><span style="color:#F8F8F2"> recursive_cte_name</span></span>
<span class="line"><span style="color:#FF79C6">  WHERE</span><span style="color:#F8F8F2"> ... </span><span style="color:#6272A4">-- Termination condition</span></span>
<span class="line"><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#F8F8F2"> ...</span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> recursive_cte_name;</span></span>
<span class="line"></span></code></pre>
<h2 id="example">Example</h2>
<p>Suppose we have a table called <code>employees</code> to represent an organization’s hierarchy. Each row represents an employee with their <code>employee_id</code>, <code>employee_name</code>, and their <code>manager_id</code> (referring to the <code>employee_id</code> of their manager).</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> TABLE</span><span style="color:#50FA7B"> employees</span><span style="color:#F8F8F2"> (</span></span>
<span class="line"><span style="color:#F8F8F2">  employee_id </span><span style="color:#FF79C6">INT</span><span style="color:#FF79C6"> PRIMARY KEY</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">  employee_name </span><span style="color:#FF79C6">VARCHAR</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">255</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#F8F8F2">  manager_id </span><span style="color:#FF79C6">INT</span></span>
<span class="line"><span style="color:#F8F8F2">);</span></span>
<span class="line"></span></code></pre>
<p>Insert sample data:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">INSERT INTO</span><span style="color:#F8F8F2"> employees (employee_id, employee_name, manager_id)</span></span>
<span class="line"><span style="color:#FF79C6">VALUES</span><span style="color:#F8F8F2"> (</span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Alice</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">NULL</span><span style="color:#F8F8F2">),   </span><span style="color:#6272A4">-- CEO</span></span>
<span class="line"><span style="color:#F8F8F2">       (</span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Bob</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">1</span><span style="color:#F8F8F2">),        </span><span style="color:#6272A4">-- Manager</span></span>
<span class="line"><span style="color:#F8F8F2">       (</span><span style="color:#BD93F9">3</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Charlie</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">),    </span><span style="color:#6272A4">-- Employee</span></span>
<span class="line"><span style="color:#F8F8F2">       (</span><span style="color:#BD93F9">4</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">David</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">),      </span><span style="color:#6272A4">-- Employee</span></span>
<span class="line"><span style="color:#F8F8F2">       (</span><span style="color:#BD93F9">5</span><span style="color:#F8F8F2">, </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Eva</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">3</span><span style="color:#F8F8F2">);        </span><span style="color:#6272A4">-- Employee</span></span>
<span class="line"></span></code></pre>
<p>If we want to retrieve the entire organization hierarchy (i.e., chain of command from the CEO down to the individual employee), we can use a recursive CTE as follows:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">WITH</span><span style="color:#FF79C6"> RECURSIVE</span><span style="color:#F8F8F2"> org_hierarchy (employee_id, employee_name, </span><span style="color:#FF79C6">level</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">AS</span><span style="color:#F8F8F2"> (</span></span>
<span class="line"><span style="color:#6272A4">  -- Initial query (find the CEO)</span></span>
<span class="line"><span style="color:#FF79C6">  SELECT</span><span style="color:#F8F8F2"> employee_id, employee_name, </span><span style="color:#BD93F9">1</span></span>
<span class="line"><span style="color:#FF79C6">  FROM</span><span style="color:#F8F8F2"> employees</span></span>
<span class="line"><span style="color:#FF79C6">  WHERE</span><span style="color:#F8F8F2"> manager_id </span><span style="color:#FF79C6">IS</span><span style="color:#FF79C6"> NULL</span></span>
<span class="line"><span style="color:#F8F8F2">  </span></span>
<span class="line"><span style="color:#FF79C6">  UNION ALL</span></span>
<span class="line"><span style="color:#F8F8F2">  </span></span>
<span class="line"><span style="color:#6272A4">  -- Recursive query (find subordinates of the previously found employees)</span></span>
<span class="line"><span style="color:#FF79C6">  SELECT</span><span style="color:#BD93F9"> e</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">employee_id</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">e</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">employee_name</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">oh</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">level</span><span style="color:#FF79C6"> +</span><span style="color:#BD93F9"> 1</span></span>
<span class="line"><span style="color:#FF79C6">  FROM</span><span style="color:#F8F8F2"> employees e</span></span>
<span class="line"><span style="color:#FF79C6">  JOIN</span><span style="color:#F8F8F2"> org_hierarchy oh </span><span style="color:#FF79C6">ON</span><span style="color:#BD93F9"> e</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">manager_id</span><span style="color:#FF79C6"> =</span><span style="color:#BD93F9"> oh</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">employee_id</span></span>
<span class="line"><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#FF79C6"> *</span></span>
<span class="line"><span style="color:#FF79C6">FROM</span><span style="color:#F8F8F2"> org_hierarchy</span></span>
<span class="line"><span style="color:#FF79C6">ORDER BY</span><span style="color:#FF79C6"> level</span><span style="color:#F8F8F2">, employee_id;</span></span>
<span class="line"></span></code></pre>
<p>This query will return the following result:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>employee_id | employee_name | level</span></span>
<span class="line"><span>------------+---------------+-------</span></span>
<span class="line"><span>         1  | Alice         |  1</span></span>
<span class="line"><span>         2  | Bob           |  2</span></span>
<span class="line"><span>         3  | Charlie       |  3</span></span>
<span class="line"><span>         4  | David         |  3</span></span>
<span class="line"><span>         5  | Eva           |  4</span></span>
<span class="line"><span></span></span></code></pre>
<p>In the example above, our recursive CTE iterates through the organization hierarchy, following the chain of command from the CEO to each employee at different levels, and yields the result as a single flat table.</p>
<p>Note that recursive CTEs can be complex, and it’s important to ensure a proper termination condition to avoid infinite recursion. Also, be careful with the use of <code>UNION ALL</code> or <code>UNION</code>, as it may impact the results and the performance of your query.</p>