<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/110-advanced-topics/102-advanced-sql/100-pl-pgsql.md"></div> <h1 id="plpgsql---procedural-language-for-postgresql">PL/pgSQL - Procedural Language for PostgreSQL</h1>
<p><code>PL/pgSQL</code> is a procedural language for the PostgreSQL database system that enables you to create stored procedures and functions using conditionals, loops, and other control structures, similar to a traditional programming language.</p>
<h2 id="why-plpgsql">Why PL/pgSQL?</h2>
<p>Using PL/pgSQL, you can perform complex operations on the server-side, reducing the need to transfer data between the server and client. This can significantly improve performance, and it enables you to encapsulate and modularize your logic within the database.</p>
<h2 id="language-features">Language Features</h2>
<p>Here are some of the key features of PL/pgSQL:</p>
<ul>
<li>Easy to learn for those familiar with other procedural languages, such as PL/SQL (Oracle) or T-SQL (Microsoft SQL Server)</li>
<li>Provides standard programming constructs like variables, loops, conditionals, and exception handling</li>
<li>Supports the use of cursors for traversing query results</li>
<li>Can call other stored procedures and functions</li>
<li>Enables returning single values or result-sets as output</li>
<li>Highly extensible and supports custom user-defined data types</li>
<li>Offers transaction control within the code</li>
</ul>
<h2 id="creating-functions-in-plpgsql">Creating Functions in PL/pgSQL</h2>
<p>To create a new function, you use the <code>CREATE FUNCTION</code> statement. Here’s a simple example of a PL/pgSQL function:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> FUNCTION</span><span style="color:#50FA7B"> add_numbers</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">integer</span><span style="color:#F8F8F2">, </span><span style="color:#FF79C6">integer</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">RETURNS</span><span style="color:#FF79C6"> integer</span><span style="color:#FF79C6"> AS</span><span style="color:#F8F8F2"> $$</span></span>
<span class="line"><span style="color:#FF79C6">DECLARE</span></span>
<span class="line"><span style="color:#F8F8F2">  sum </span><span style="color:#FF79C6">integer</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">BEGIN</span></span>
<span class="line"><span style="color:#F8F8F2">  sum :</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> $</span><span style="color:#BD93F9">1</span><span style="color:#FF79C6"> +</span><span style="color:#F8F8F2"> $</span><span style="color:#BD93F9">2</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  RETURN</span><span style="color:#F8F8F2"> sum;</span></span>
<span class="line"><span style="color:#FF79C6">END</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">$$ </span><span style="color:#FF79C6">LANGUAGE</span><span style="color:#F8F8F2"> plpgsql;</span></span>
<span class="line"></span></code></pre>
<p>This function takes two integers as input parameters and returns their sum.</p>
<h2 id="using-functions-inqueries">Using Functions inQueries</h2>
<p>You can use functions within queries like any other PostgreSQL function:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">SELECT</span><span style="color:#F8F8F2"> add_numbers(</span><span style="color:#BD93F9">5</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">10</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span></code></pre>
<p>This query would return <code>15</code>.</p>
<h2 id="error-handling-and-exception-catches">Error Handling and Exception Catches</h2>
<p>PL/pgSQL supports error handling through the use of <code>EXCEPTION</code> blocks. Here’s an example of a function that handles division by zero:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> FUNCTION</span><span style="color:#50FA7B"> safe_divide</span><span style="color:#F8F8F2">(numerator </span><span style="color:#FF79C6">integer</span><span style="color:#F8F8F2">, denominator </span><span style="color:#FF79C6">integer</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#FF79C6">RETURNS</span><span style="color:#FF79C6"> integer</span><span style="color:#FF79C6"> AS</span><span style="color:#F8F8F2"> $$</span></span>
<span class="line"><span style="color:#FF79C6">DECLARE</span></span>
<span class="line"><span style="color:#F8F8F2">  result </span><span style="color:#FF79C6">integer</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">BEGIN</span></span>
<span class="line"><span style="color:#F8F8F2">  result :</span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> numerator </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> denominator;</span></span>
<span class="line"><span style="color:#FF79C6">  RETURN</span><span style="color:#F8F8F2"> result;</span></span>
<span class="line"><span style="color:#F8F8F2">EXCEPTION </span><span style="color:#FF79C6">WHEN</span><span style="color:#F8F8F2"> division_by_zero </span><span style="color:#FF79C6">THEN</span></span>
<span class="line"><span style="color:#F8F8F2">  RAISE WARNING </span><span style="color:#E9F284">'</span><span style="color:#F1FA8C">Division by zero occurred. Returning NULL</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  RETURN</span><span style="color:#FF79C6"> NULL</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">END</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">$$ </span><span style="color:#FF79C6">LANGUAGE</span><span style="color:#F8F8F2"> plpgsql;</span></span>
<span class="line"></span></code></pre>
<h2 id="triggers-and-plpgsql">Triggers and PL/pgSQL</h2>
<p>You can also create triggers using PL/pgSQL. Triggers are user-defined functions that are invoked automatically when an event such as insert, update or delete occurs.</p>
<p>Here’s an example of a trigger function that logs the change of user’s email address:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> FUNCTION</span><span style="color:#50FA7B"> log_email_change</span><span style="color:#F8F8F2">()</span></span>
<span class="line"><span style="color:#FF79C6">RETURNS</span><span style="color:#F8F8F2"> trigger </span><span style="color:#FF79C6">AS</span><span style="color:#F8F8F2"> $$</span></span>
<span class="line"><span style="color:#FF79C6">BEGIN</span></span>
<span class="line"><span style="color:#FF79C6">  IF</span><span style="color:#BD93F9"> NEW</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">email</span><span style="color:#FF79C6"> &#x3C;></span><span style="color:#BD93F9"> OLD</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">email</span><span style="color:#FF79C6"> THEN</span></span>
<span class="line"><span style="color:#FF79C6">    INSERT INTO</span><span style="color:#F8F8F2"> user_email_changes (user_id, old_email, new_email)</span></span>
<span class="line"><span style="color:#FF79C6">    VALUES</span><span style="color:#F8F8F2"> (</span><span style="color:#BD93F9">OLD</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">user_id</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">OLD</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">email</span><span style="color:#F8F8F2">, </span><span style="color:#BD93F9">NEW</span><span style="color:#F8F8F2">.</span><span style="color:#BD93F9">email</span><span style="color:#F8F8F2">);</span></span>
<span class="line"><span style="color:#FF79C6">  END</span><span style="color:#FF79C6"> IF</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">  RETURN</span><span style="color:#F8F8F2"> NEW;</span></span>
<span class="line"><span style="color:#FF79C6">END</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">$$ </span><span style="color:#FF79C6">LANGUAGE</span><span style="color:#F8F8F2"> plpgsql;</span></span>
<span class="line"></span></code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>PL/pgSQL is a powerful and versatile procedural language that brings traditional programming constructs to the PostgreSQL database. It enables you to perform complex operations on the server-side and is particularly useful for creating stored procedures, functions, and triggers.</p>