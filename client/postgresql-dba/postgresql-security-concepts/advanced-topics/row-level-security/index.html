<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/postgresql-dba/content/106-postgresql-security-concepts/101-advanced-topics/100-row-level-security.md"></div> <h1 id="row-level-security-rls">Row Level Security (RLS)</h1>
<p>Row Level Security (RLS) is a feature introduced in PostgreSQL 9.5 that allows you to control access to rows in a table based on a user or role’s permissions. This level of granularity in data access provides an extra layer of security for protecting sensitive information from unauthorized access.</p>
<h2 id="enabling-row-level-security">Enabling Row Level Security</h2>
<p>To enable RLS, you need to set up policies for your table. A policy is a set of rules that define how users can read or modify table rows. First, enable RLS on the table using the <code>ALTER TABLE</code> command with the <code>FORCE ROW LEVEL SECURITY</code> option:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">ALTER</span><span style="color:#FF79C6"> TABLE</span><span style="color:#F8F8F2"> my_table </span><span style="color:#FF79C6">FORCE</span><span style="color:#FF79C6"> ROW</span><span style="color:#FF79C6"> LEVEL</span><span style="color:#FF79C6"> SECURITY</span><span style="color:#F8F8F2">;</span></span>
<span class="line"></span></code></pre>
<h2 id="creating-policies">Creating Policies</h2>
<p>To create a policy, use the <code>CREATE POLICY</code> command with a <code>USING</code> clause that specifies the conditions for allowing access to a row. Here’s an example of a policy that allows users to read rows only if the user’s <code>id</code> is equal to the <code>user_id</code> column in the table:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> POLICY</span><span style="color:#F8F8F2"> my_policy </span><span style="color:#FF79C6">ON</span><span style="color:#F8F8F2"> my_table </span></span>
<span class="line"><span style="color:#FF79C6">FOR</span><span style="color:#FF79C6"> SELECT</span><span style="color:#F8F8F2"> </span></span>
<span class="line"><span style="color:#FF79C6">USING</span><span style="color:#F8F8F2"> (current_user_id() </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> user_id);</span></span>
<span class="line"></span></code></pre>
<p>You can also create policies for modifying rows by specifying the <code>FOR</code> action as <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code>.</p>
<h2 id="example-role-based-rls">Example: Role-Based RLS</h2>
<p>Suppose you want to restrict access based on user roles. In this example, we have three roles: <code>admin</code>, <code>manager</code>, and <code>employee</code>. We want to give <code>admin</code> access to all rows, <code>manager</code> access to rows of their department, and <code>employee</code> access only to their own rows.</p>
<p>First, create policies for each role:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#6272A4">-- Admin Policy</span></span>
<span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> POLICY</span><span style="color:#F8F8F2"> admin_policy </span><span style="color:#FF79C6">ON</span><span style="color:#F8F8F2"> my_table </span></span>
<span class="line"><span style="color:#FF79C6">FOR</span><span style="color:#F8F8F2"> ALL </span></span>
<span class="line"><span style="color:#FF79C6">USING</span><span style="color:#F8F8F2"> (current_role </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">admin</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">-- Manager Policy</span></span>
<span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> POLICY</span><span style="color:#F8F8F2"> manager_policy </span><span style="color:#FF79C6">ON</span><span style="color:#F8F8F2"> my_table </span></span>
<span class="line"><span style="color:#FF79C6">FOR</span><span style="color:#FF79C6"> SELECT</span><span style="color:#F8F8F2"> </span></span>
<span class="line"><span style="color:#FF79C6">USING</span><span style="color:#F8F8F2"> (current_role </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">manager</span><span style="color:#E9F284">'</span><span style="color:#FF79C6"> AND</span><span style="color:#F8F8F2"> department_id </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> current_department_id());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">-- Employee Policy</span></span>
<span class="line"><span style="color:#FF79C6">CREATE</span><span style="color:#FF79C6"> POLICY</span><span style="color:#F8F8F2"> employee_policy </span><span style="color:#FF79C6">ON</span><span style="color:#F8F8F2"> my_table </span></span>
<span class="line"><span style="color:#FF79C6">FOR</span><span style="color:#FF79C6"> SELECT</span><span style="color:#F8F8F2"> </span></span>
<span class="line"><span style="color:#FF79C6">USING</span><span style="color:#F8F8F2"> (current_role </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> '</span><span style="color:#F1FA8C">employee</span><span style="color:#E9F284">'</span><span style="color:#FF79C6"> AND</span><span style="color:#F8F8F2"> user_id </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> current_user_id());</span></span>
<span class="line"></span></code></pre>
<p>With these policies in place, users with different roles will have access to rows as per their designated privileges.</p>
<p>In summary, Row Level Security is a powerful feature in PostgreSQL that helps you control access to your data at a granular level. By defining policies and conditions for each user or role, you can ensure that sensitive information is protected, and users only have access to the data they need.</p>