<div data-github-url="https://github.com/kamranahmedse/developer-roadmap/tree/master/src/data/roadmaps/cpp/content/105-pointers-and-references/smart-pointers/100-weak-ptr.md"></div> <h1 id="weak-pointer">Weak Pointer</h1>
<p>A <code>weak_ptr</code> is a type of smart pointer in C++ that adds a level of indirection and safety to a raw pointer. It is mainly used to break reference cycles in cases where two objects have shared pointers to each other, or when you need a non-owning reference to an object that is managed by a <code>shared_ptr</code>.</p>
<p>A <code>weak_ptr</code> does not increase the <em>ownership</em> reference count of the object it points to, which is a key difference between <code>weak_ptr</code> and <code>shared_ptr</code>. The control block associated with the object maintains two counts: one for the number of <code>shared_ptr</code>s (ownership count) and another for the number of <code>weak_ptr</code>s (weak count). The existence of <code>weak_ptr</code>s does not prevent the object from being deleted; the object is destroyed once the last <code>shared_ptr</code> that owns it is destroyed or reset, even if <code>weak_ptr</code>s are still referencing the object. However, the control block itself is not deallocated until both the ownership count reaches zero and the weak count also reaches zero, allowing <code>weak_ptr</code>s to safely detect whether the object has already been deleted.</p>
<p>To use a <code>weak_ptr</code>, you must convert it to a <code>shared_ptr</code> using the <code>lock()</code> function, which tries to create a new <code>shared_ptr</code> that shares ownership of the object. If successful, the object’s reference count is increased and you can use the returned <code>shared_ptr</code> to safely access the object.</p>
<p>Here’s an example of using <code>weak_ptr</code>:</p>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0" data-language="cpp"><code><span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">iostream</span><span style="color:#E9F284">></span></span>
<span class="line"><span style="color:#FF79C6">#include</span><span style="color:#E9F284"> &#x3C;</span><span style="color:#F1FA8C">memory</span><span style="color:#E9F284">></span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">class</span><span style="color:#8BE9FD"> MyClass</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#FF79C6">public:</span></span>
<span class="line"><span style="color:#FF79C6">    void</span><span style="color:#50FA7B"> DoSomething</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#F8F8F2">        std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">cout </span><span style="color:#FF79C6">&#x3C;&#x3C;</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">Doing something...</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">int</span><span style="color:#50FA7B"> main</span><span style="color:#F8F8F2">() {</span></span>
<span class="line"><span style="color:#F8F8F2">    std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">weak_ptr</span><span style="color:#FF79C6">&#x3C;</span><span style="color:#F8F8F2">MyClass</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2"> weak;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2">    {</span></span>
<span class="line"><span style="color:#F8F8F2">        std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">shared_ptr</span><span style="color:#FF79C6">&#x3C;</span><span style="color:#F8F8F2">MyClass</span><span style="color:#FF79C6">></span><span style="color:#F8F8F2"> shared </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> std</span><span style="color:#FF79C6">::</span><span style="color:#50FA7B">make_shared</span><span style="color:#F8F8F2">&#x3C;</span><span style="color:#8BE9FD;font-style:italic">MyClass</span><span style="color:#F8F8F2">>();</span></span>
<span class="line"><span style="color:#F8F8F2">        weak </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> shared;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">        if</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">auto</span><span style="color:#F8F8F2"> sharedFromWeak </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> weak.</span><span style="color:#50FA7B">lock</span><span style="color:#F8F8F2">()) {</span></span>
<span class="line"><span style="color:#F8F8F2">            sharedFromWeak</span><span style="color:#FF79C6">-></span><span style="color:#50FA7B">DoSomething</span><span style="color:#F8F8F2">();</span><span style="color:#6272A4"> // Safely use the object</span></span>
<span class="line"><span style="color:#F8F8F2">            std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">cout </span><span style="color:#FF79C6">&#x3C;&#x3C;</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">Shared uses count: </span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> &#x3C;&#x3C;</span><span style="color:#F8F8F2"> sharedFromWeak.</span><span style="color:#50FA7B">use_count</span><span style="color:#F8F8F2">() </span><span style="color:#FF79C6">&#x3C;&#x3C;</span><span style="color:#E9F284"> '</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">'</span><span style="color:#F8F8F2">;</span><span style="color:#6272A4"> // 2</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4">    // shared goes out of scope and the MyClass object is destroyed</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">auto</span><span style="color:#F8F8F2"> sharedFromWeak </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> weak.</span><span style="color:#50FA7B">lock</span><span style="color:#F8F8F2">()) {</span></span>
<span class="line"><span style="color:#6272A4">        // This block will not be executed because the object is destroyed</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#FF79C6">    else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">        std</span><span style="color:#FF79C6">::</span><span style="color:#F8F8F2">cout </span><span style="color:#FF79C6">&#x3C;&#x3C;</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">Object has been destroyed</span><span style="color:#FF79C6">\n</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#BD93F9"> 0</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p>In this example, we create a <code>shared_ptr</code> named <code>shared</code> that manages a <code>MyClass</code> object. By assigning it to a <code>weak_ptr</code> named <code>weak</code>, we store a non-owning reference to the object. Inside the inner scope, we create a new <code>shared_ptr</code> named <code>sharedFromWeak</code> using <code>weak.lock()</code> to safely use the object. After the inner scope, the <code>MyClass</code> object is destroyed since <code>shared</code> goes out of scope, and any further attempt to create a <code>shared_ptr</code> from <code>weak</code> will fail as the object is already destroyed.</p>
<p>Learn more from the following resources:</p>
<ul>
<li><a href="https://en.cppreference.com/w/cpp/memory/weak_ptr" rel="noopener noreferrer nofollow" target="_blank">@article@CPP Reference</a></li>
</ul>